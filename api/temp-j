stage('API Test') {
	podTemplate(label: 'jenkins-python3nodejs', name: 'jenkins-python3nodejs', serviceAccount: 'jenkins', cloud: 'openshift', containers: [
	containerTemplate(
		name: 'jnlp',
		image: '172.50.0.2:5000/openshift/jenkins-slave-python3nodejs',
		resourceRequestCpu: '500m',
		resourceLimitCpu: '1000m',
		resourceRequestMemory: '1Gi',
		resourceLimitMemory: '2Gi',
		workingDir: '/tmp',
		command: '',
		args: '${computer.jnlpmac} ${computer.name}'
	  )
	],envVars: [
		envVar(key:'BASEURL', value: "https://namex-dev.pathfinder.gov.bc.ca"),
		secretEnvVar(key: 'DEV_API_TEST_USER', secretName: 'apitest-secrets', secretKey: 'username'),
		secretEnvVar(key: 'DEV_API_TEST_PASSWORD', secretName: 'apitest-secrets', secretKey: 'password'),
		secretEnvVar(key: 'DEV_API_TEST_AUTH_SERVER', secretName: 'apitest-secrets', secretKey: 'authurl'),
		secretEnvVar(key: 'DEV_API_TEST_CLIENT_ID', secretName: 'apitest-secrets', secretKey: 'clientid'),
		secretEnvVar(key: 'DEV_API_TEST_CLIENT_SECRET', secretName: 'apitest-secrets', secretKey: 'client_secret')
	])
	{
//		node("nodejs-${context.uuid}") {
		node('jenkins-python3nodejs') {
		//the checkout is mandatory, otherwise functional test would fail
			echo "checking out source"authurl
			echo "Build: ${BUILD_ID}"
			echo "baseURL: ${baseURL}"
			sh '''#!/bin/bash
				echo BASEURL=$BASEURL
			'''

			//input(message: "Verify Environment variables. Continue?")
			checkout scm
			dir('tests/postman') {
				sh 'npm install -g newman'

				try {
					sh 'newman run ./registries_api_tests.json --global-var userid=$DEV_API_TEST_USER --global-var password=$DEV_API_TEST_PASSWORD --global-var base_url="${BASEURL}" --global-var authurl=$DEV_API_TEST_AUTH_SERVER --global-var clientid=$DEV_API_TEST_CLIENT_ID --global-var client_secret=$DEV_API_TEST_CLIENT_SECRET -r cli,junit,html;'
				} finally {
						junit 'newman/*.xml'
						publishHTML (target: [
									allowMissing: false,
									alwaysLinkToLastBuild: false,
									keepAll: true,
									reportDir: 'newman',
									reportFiles: 'newman*.html',
									reportName: "API Test Report"
								])
						stash includes: 'newman/*.xml', name: 'api-tests'
				}
			} // end dir
		} //end node
	} //end podTemplate
} //end stage
